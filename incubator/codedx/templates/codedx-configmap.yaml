{{- if and .Values.codedx.props.file (not .Values.codedx.props.configMap) -}}
apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "codedx.props.configMapName" . }}
  labels:
    helm.sh/chart: {{ include "codedx.chart" . }}
    app.kubernetes.io/instance: {{ .Release.Name }}
    app.kubernetes.io/managed-by: {{ .Release.Service }}
    app.kubernetes.io/component: frontend
    app.kubernetes.io/part-of: codedx
  annotations:
{{ toYaml .Values.codedx.props.annotations | indent 4 }}
data:
  {{- /* We use `replace` here instead of usual file templating. A `codedx.props` file can contain documenting */ -}}
  {{- /* comments with sample parameters named ie "{{project.name}}". Rather than try to trim comments from the output */ -}}
  {{- /* or change the `codedx.props` sample file, we use a simple text-replace for flexibility. */ -}}
  {{- $dbUrl := (printf "jdbc:mysql://%s-mariadb/codedx" .Release.Name) -}}
  {{- $propsContents := .Files.Get .Values.codedx.props.file -}}

  {{- $propsContents := ($propsContents | replace "TPL_K8S_DB_URL" $dbUrl) }}
  codedx.props: |-
    {{- $propsContents | nindent 4 }}

  tomcat.env: |-
    export CATALINA_OPTS={{ include "codedx.props.params.combined" . }}

  {{ if .Values.codedx.logging.configFile -}}
  logback.xml: |-
    {{- .Files.Get .Values.codedx.logging.configFile | nindent 4 -}}
  {{- end -}}

{{- end -}}